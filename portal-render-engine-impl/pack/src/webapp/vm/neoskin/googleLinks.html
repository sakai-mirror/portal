<script type="text/javascript">
  var $googleLinksMenu = null;

  // NOTE: Best place for all of this is in .js file; would need to be retrieved as <script src="myJsUrl" type="text/javascript">< /script> inside <head>
  $(document).ready(function(){
	$googleLinksMenu = $('#googleLinksMenu');
	if (getGoogleLinksMenu().length === 0) {
	  console.warn('M+Google menu not found: #googleLinks');
	}
    $("#glc").click(function(e) {
      e.preventDefault();
	  // Toggle the menu, and make Google AJAX requests if the menu is being opened
      if ($(this).siblings('ul').toggle().is(':visible')) {
		setTimeout('getCalendarEventsToday()', 1);
		setTimeout('getUnreadEmailCount()', 1);
		setTimeout('getRecentlyModifiedDriveDocs()', 1);
		setTimeout('getGooglePlusRecentReplies()', 1);
     }
    });
  });

  /**
   * Returns jQuery object for the "M+ Google" link, length 0 if the link DNE.
   */
  function getGoogleLinksMenu() {
    return $googleLinksMenu;
  }

function getGoogleAccessToken() {
  return googleLinksConfig.accessToken;
}

function getUserGoogleCalendarId() {
  return googleLinksConfig.userCalendarId;
}

function getConfigDriveDocsMaximumAgeDays() {
  var result = googleLinksConfig.driveDocsMaximumAgeDays;
  if (isNaN(result)) {
	result = 14;
  }
  return result;
}

function getConfigDriveDocsMaximumAgeMs() {
  return getConfigDriveDocsMaximumAgeDays() * 86400000;
}

function getRecentlyModifiedDriveDocs() {
  var oldestTimeMs =
	  clearTime(new Date()).getTime() - getConfigDriveDocsMaximumAgeMs();
  reportCountOfDriveDocsModifiedAfterTime(new Date(oldestTimeMs));
}

/**
 * The goal for this is to find # of docs created/updated in the user's Google
 * Drive today.
 */
function getDriveDocsToday() {
	reportCountOfDriveDocsModifiedAfterTime(clearTime(new Date()));
}

/**
 * Updates M+Google menu to show files that were modified after the given time,
 * and not viewed by me since then.
 */
function reportCountOfDriveDocsModifiedAfterTime(oldestTime) {
	var accessToken = getGoogleAccessToken();
	// Return if parameters for Google AJAX request are not valid
	if (!verifyGoogleAccess(accessToken)) {
	  return;
	}
	var driveUrl = $('#DriveUrl').val();
	if ($.trim(driveUrl) === '') {
		driveUrl = 'https://www.googleapis.com/drive/v2/files';
	}
	console.log('Drive URL: "' + driveUrl + '"');
	jQuery.ajax({
			url: driveUrl,
			beforeSend: function(xhr) {
			  xhr.setRequestHeader("Authorization", "GoogleLogin auth=" + accessToken);
			},
			dataType: 'json',
			data: {
				'access_token' : accessToken,
				'q': 'modifiedDate > "' + getTimeIso(oldestTime, true) + '"'
			},
			success: function(data) {
				var files = data.items;
				if (files) {
					// Filter to count only files updated after last time I
					// viewed them
					var recentlyModifiedCount = 0;
					for (var fileIdx in files) {
						var file = files[fileIdx];
						// file date example: 2013-03-20T16:28:58.447Z
						// ISO 8601 format natural sort is chronological order
						if (file.modifiedDate > file.lastViewedByMeDate) {
							recentlyModifiedCount++;
						}
					}
					updateGoogleDriveInMenu(recentlyModifiedCount);
				} else {
					updateGoogleDriveInMenu('');
				}
			},
		});
}

function getCalendarEventsToday() {
	var accessToken = getGoogleAccessToken();
	var gcalId = getUserGoogleCalendarId();
	// Return if parameters for Google AJAX request are not valid
	if (!verifyGoogleAccess(accessToken, gcalId)) {
	  return;
	}
	// Must stop if access token is empty
	var todayStart = clearTime(new Date());//new Date().getTime() - 86400000));
	// Adding 1 day in milliseconds
	var todayEnd = new Date(todayStart.getTime() + (86400000) - 10);
	console.debug('Sending AJAX query for Calendar events for today.');
	jQuery.ajax({
			url: 'https://www.googleapis.com/calendar/v3/calendars/' + gcalId + '/events?access_token=' + accessToken,
			dataType: 'json',
			data: {
				timeMin: getTimeIso(todayStart, true),
				timeMax: getTimeIso(todayEnd, true)
			},
			success: function(data) {
			  var eventCount = (data.items ? data.items.length : 0);
			  updateGoogleMenu('googleCalendar', eventCount);
			},
		});
}

function getUnreadEmailCount() {
	var accessToken = getGoogleAccessToken();
	var userEmailAddress = 'test@collab.its.umich.edu';
	// Return if parameters for Google AJAX request are not valid
	if (!verifyGoogleAccess(accessToken, userEmailAddress)) {
	  return;
	}
	$.ajax({
		url: '/google-integration-prototype/gmailAtomProxy',
			beforeSend: function(xhr) {
			  xhr.setRequestHeader("Authorization", "GoogleLogin auth=" + accessToken);
			},
			data: 'access_token=' + accessToken,
			dataType: 'text',
			success: function(data) {
				var fullCountBegin = data.indexOf('<fullcount>') + 11;
				var fullCountEnd = data.indexOf('</fullcount>');
				if ((fullCountBegin > -1) && (fullCountEnd > fullCountBegin)) {
					updateUnreadEmailCountInMenu(data.substring(fullCountBegin, fullCountEnd));
				} else {
					// Note: If this is result of user having too many unread
					// email, the feed may include a number of unread email,
					// although that would not be the actual number, and not
					// certain it would ever be zero.
					alert('Count of unread email not found.  This could be due to you having too many unread email to count.');
					updateUnreadEmailCountInMenu('');
				}
			},
			error: function(jqXHR, textStatus, errorThrown) {
				alert('Failed to get unread email count: ' + textStatus + ' \n' + errorThrown);
			}
		});
}

function updateGoogleMenu(menuItemClass, data, title) {
  // Links parent
  var $menuItem = getGoogleLinksMenu().find('li.' + menuItemClass);
  if ($menuItem.length === 0) {
	// Menu does not exist, so nothing to do
	return;
  }
  // Span to show user-data
  var $userDataSpan = $menuItem.find('span.userData');
  if (data == 0) {
	data = '';
  }
	$userDataSpan.text(data);

	// Update title, keeping original title so updates can be made cleanly.
	var origTitle = $menuItem.data('origTitle');
	if (origTitle == null) {
		// Triming so undefined & null are treated as ''
		origTitle = $.trim($menuItem.attr('title'));
		$menuItem.data('origTitle', origTitle);
	}

	// TODO: change this to use i18n compatible text
	if (title !== '') {
		$menuItem.attr('title', title);
	} else {
		$menuItem.attr('title', origTitle);
	}
}

function updateGoogleDriveInMenu(data) {
	updateGoogleMenu('googleDrive', data, '');
}

function updateUnreadEmailCountInMenu(count) {
	if (isNaN(count)) {
		updateGoogleMenu('googleMail', '', '');
	} else {
		updateGoogleMenu('googleMail', count, count + ' unread');
	}
}

function getGooglePlusRecentReplies() {
	  var accessToken = getGoogleAccessToken();
	  // Return if parameters for Google AJAX request are not valid
	  if (!verifyGoogleAccess(accessToken)) {
	    return;
	  }
	  var ajaxResult = $.ajax({
		url: 'https://www.googleapis.com/plus/v1/people/me/activities/public',
        data: { 'access_token' : accessToken },
		async: true,
		complete: function(jqXHR, textStatus) {
		  if (textStatus != 'success') {
			  // TODO: decide to keep the menu as is, or to clear out any entry
			  console.debug('Failed to get Google+ activities: ' + textStatus);
		  }
		},
		success: showActivityReplies
	  });
}

function showActivityReplies(activities) {
  var replyCount = 0;
  var todayStart = clearTime(new Date());
  if (activities.items) {
	for (var i = 0; i < activities.items.length; i++) {
		var activity = activities.items[i];
		// Check if there are replies
		var replies = activity.object.replies.totalItems;
		if (replies && !isNaN(replies)) {
			// There are replies: add to count if activity was created today
			var activityPublished = new Date(activity.published);
			if (todayStart <= activityPublished) {
				replyCount = replyCount + replies;
			}
		}
	}
  }
  updateGoogleMenu('googlePlus', replyCount);
}

/**
 * Checks if access token is valid, to avoid making improper requests to Google
 */
function verifyGoogleAccess(tokens) {
  var result = true;
  for (var argIdx = 0; result && (argIdx < arguments.length); argIdx++) {
	result = ($.trim(arguments[argIdx]) !== '');
  }
  return result;
}

/**
 * clearTime(d) copied from fulcalendar.js
 */
 function clearTime(d) {
		d.setHours(0);
		d.setMinutes(0);
		d.setSeconds(0); 
		d.setMilliseconds(0);
		return d;
	}

/**
 * Returns date & time in ISO format, adjusting to current time zone if caller
 * wants that (Google timeMin/timeMax use current time zone instead of UTC)
 */
function getTimeIso(dt, useLocalTimezone) {
	// From: http://stackoverflow.com/questions/2573521/how-do-i-output-an-iso-8601-formatted-string-in-javascript
	if (!Date.prototype.toISOString) {
	    Date.prototype.toISOString = function() {
	        function pad(n) { return n < 10 ? '0' + n : n }
	        return this.getUTCFullYear() + '-'
	            + pad(this.getUTCMonth() + 1) + '-'
	            + pad(this.getUTCDate()) + 'T'
	            + pad(this.getUTCHours()) + ':'
	            + pad(this.getUTCMinutes()) + ':'
	            + pad(this.getUTCSeconds()) + 'Z';
	    };
	}
	// Modify to current timezone
	if (useLocalTimezone) {
		dt = new Date(dt.getTime() - (dt.getTimezoneOffset() * 60 * 1000));
	}
	var result = dt.toISOString();
	console.log(dt.toString() + ' ' + result);
	return result;
}

</script>
<a href="#" id="glc">M+Google  &#9662;</a>
<ul style="display:none" id="googleLinksMenu">
  <li class="googleMail">
	<a class="gm" href="http://email.umich.edu"  target="_blank">GMail</a>
	<span class="userData"></span>
  </li>
  <li class="googleDrive">
	<a class="gd" href="http://docs.umich.edu" target="_blank">Drive</a>
	<span class="userData"></span>
  </li>
  <li class="googleCalendar">
	<a class="gc" href="http://calendar.umich.edu" target="_blank">Calendar</a>
	<span class="userData"></span>
  </li>
  <li class="googlePlus">
	<a class="gp" href="https://plus.google.com" target="_blank">Google+</a>
	<span class="userData"></span>
  </li>
</ul>
